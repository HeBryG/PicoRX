#include "denoiser.h"

#include <stdio.h>
#include "pico/stdlib.h"

#define NOISE_FRAMES_NUM (4)
#define NOISE_FRAMES_ROT_PERIOD (586) // 2.5s with current SR and frame length

#define KFRAME (28423)
#define ONE_MINUS_KFRAME (4344)

static q31_t noise_frames[NOISE_FRAMES_NUM][DENOISER_FFT_SIZE / 4];
static uint8_t noise_frame_idx = 0;
static uint8_t noise_frame_counter = 0;

// clang-format off

static const q31_t db_lut[2999] = {
    0, 3946, 6254, 7891, 9161, 10199, 11077, 11837, 12507, 13107, 13649, 14145, 14600, 15022, 15415, 15782,
    16127, 16453, 16760, 17052, 17330, 17595, 17848, 18090, 18323, 18546, 18761, 18968, 19167, 19360, 19547, 19728,
    19903, 20073, 20238, 20398, 20554, 20706, 20854, 20998, 21138, 21276, 21410, 21540, 21668, 21793, 21916, 22036,
    22153, 22268, 22381, 22491, 22600, 22706, 22811, 22913, 23014, 23113, 23210, 23306, 23400, 23493, 23584, 23673,
    23761, 23848, 23934, 24018, 24101, 24183, 24264, 24344, 24422, 24500, 24576, 24651, 24726, 24799, 24872, 24943,
    25014, 25084, 25153, 25221, 25289, 25355, 25421, 25486, 25550, 25614, 25677, 25739, 25801, 25861, 25922, 25981,
    26040, 26099, 26156, 26214, 26270, 26326, 26382, 26437, 26491, 26545, 26599, 26652, 26704, 26756, 26808, 26859,
    26909, 26959, 27009, 27058, 27107, 27156, 27204, 27251, 27299, 27346, 27392, 27438, 27484, 27529, 27574, 27619,
    27663, 27707, 27751, 27794, 27837, 27880, 27922, 27964, 28006, 28047, 28088, 28129, 28169, 28210, 28250, 28289,
    28329, 28368, 28407, 28445, 28484, 28522, 28559, 28597, 28634, 28671, 28708, 28745, 28781, 28817, 28853, 28889,
    28924, 28960, 28995, 29030, 29064, 29099, 29133, 29167, 29200, 29234, 29267, 29301, 29334, 29366, 29399, 29431,
    29464, 29496, 29528, 29559, 29591, 29622, 29653, 29685, 29715, 29746, 29777, 29807, 29837, 29867, 29897, 29927,
    29956, 29986, 30015, 30044, 30073, 30102, 30131, 30159, 30188, 30216, 30244, 30272, 30300, 30327, 30355, 30382,
    30410, 30437, 30464, 30491, 30518, 30544, 30571, 30597, 30624, 30650, 30676, 30702, 30727, 30753, 30779, 30804,
    30830, 30855, 30880, 30905, 30930, 30955, 30979, 31004, 31028, 31053, 31077, 31101, 31125, 31149, 31173, 31197,
    31221, 31244, 31268, 31291, 31314, 31338, 31361, 31384, 31407, 31429, 31452, 31475, 31497, 31520, 31542, 31564,
    31587, 31609, 31631, 31653, 31674, 31696, 31718, 31739, 31761, 31782, 31804, 31825, 31846, 31867, 31888, 31909,
    31930, 31951, 31972, 31993, 32013, 32034, 32054, 32074, 32095, 32115, 32135, 32155, 32175, 32195, 32215, 32235,
    32254, 32274, 32294, 32313, 32333, 32352, 32371, 32391, 32410, 32429, 32448, 32467, 32486, 32505, 32524, 32543,
    32561, 32580, 32598, 32617, 32635, 32654, 32672, 32690, 32709, 32727, 32745, 32763, 32781, 32799, 32817, 32834,
    32852, 32870, 32888, 32905, 32923, 32940, 32958, 32975, 32992, 33010, 33027, 33044, 33061, 33078, 33095, 33112,
    33129, 33146, 33163, 33180, 33196, 33213, 33230, 33246, 33263, 33279, 33296, 33312, 33328, 33345, 33361, 33377,
    33393, 33409, 33425, 33441, 33457, 33473, 33489, 33505, 33521, 33536, 33552, 33568, 33583, 33599, 33615, 33630,
    33646, 33661, 33676, 33692, 33707, 33722, 33737, 33752, 33768, 33783, 33798, 33813, 33828, 33843, 33857, 33872,
    33887, 33902, 33917, 33931, 33946, 33961, 33975, 33990, 34004, 34019, 34033, 34047, 34062, 34076, 34090, 34105,
    34119, 34133, 34147, 34161, 34175, 34189, 34203, 34217, 34231, 34245, 34259, 34273, 34287, 34301, 34314, 34328,
    34342, 34355, 34369, 34382, 34396, 34409, 34423, 34436, 34450, 34463, 34476, 34490, 34503, 34516, 34530, 34543,
    34556, 34569, 34582, 34595, 34608, 34621, 34634, 34647, 34660, 34673, 34686, 34699, 34712, 34724, 34737, 34750,
    34762, 34775, 34788, 34800, 34813, 34825, 34838, 34851, 34863, 34875, 34888, 34900, 34913, 34925, 34937, 34950,
    34962, 34974, 34986, 34998, 35011, 35023, 35035, 35047, 35059, 35071, 35083, 35095, 35107, 35119, 35131, 35142,
    35154, 35166, 35178, 35190, 35201, 35213, 35225, 35237, 35248, 35260, 35271, 35283, 35295, 35306, 35318, 35329,
    35341, 35352, 35363, 35375, 35386, 35398, 35409, 35420, 35431, 35443, 35454, 35465, 35476, 35488, 35499, 35510,
    35521, 35532, 35543, 35554, 35565, 35576, 35587, 35598, 35609, 35620, 35631, 35642, 35653, 35663, 35674, 35685,
    35696, 35707, 35717, 35728, 35739, 35749, 35760, 35771, 35781, 35792, 35802, 35813, 35823, 35834, 35844, 35855,
    35865, 35876, 35886, 35897, 35907, 35917, 35928, 35938, 35948, 35959, 35969, 35979, 35989, 36000, 36010, 36020,
    36030, 36040, 36050, 36060, 36071, 36081, 36091, 36101, 36111, 36121, 36131, 36141, 36151, 36161, 36170, 36180,
    36190, 36200, 36210, 36220, 36230, 36239, 36249, 36259, 36269, 36278, 36288, 36298, 36307, 36317, 36327, 36336,
    36346, 36355, 36365, 36375, 36384, 36394, 36403, 36413, 36422, 36432, 36441, 36450, 36460, 36469, 36479, 36488,
    36497, 36507, 36516, 36525, 36535, 36544, 36553, 36562, 36572, 36581, 36590, 36599, 36608, 36618, 36627, 36636,
    36645, 36654, 36663, 36672, 36681, 36690, 36699, 36708, 36717, 36726, 36735, 36744, 36753, 36762, 36771, 36780,
    36789, 36798, 36807, 36816, 36824, 36833, 36842, 36851, 36860, 36868, 36877, 36886, 36895, 36903, 36912, 36921,
    36929, 36938, 36947, 36955, 36964, 36972, 36981, 36990, 36998, 37007, 37015, 37024, 37032, 37041, 37049, 37058,
    37066, 37075, 37083, 37092, 37100, 37108, 37117, 37125, 37133, 37142, 37150, 37159, 37167, 37175, 37183, 37192,
    37200, 37208, 37216, 37225, 37233, 37241, 37249, 37258, 37266, 37274, 37282, 37290, 37298, 37306, 37314, 37323,
    37331, 37339, 37347, 37355, 37363, 37371, 37379, 37387, 37395, 37403, 37411, 37419, 37427, 37435, 37443, 37450,
    37458, 37466, 37474, 37482, 37490, 37498, 37506, 37513, 37521, 37529, 37537, 37545, 37552, 37560, 37568, 37576,
    37583, 37591, 37599, 37606, 37614, 37622, 37629, 37637, 37645, 37652, 37660, 37668, 37675, 37683, 37690, 37698,
    37706, 37713, 37721, 37728, 37736, 37743, 37751, 37758, 37766, 37773, 37781, 37788, 37796, 37803, 37810, 37818,
    37825, 37833, 37840, 37847, 37855, 37862, 37869, 37877, 37884, 37891, 37899, 37906, 37913, 37921, 37928, 37935,
    37942, 37950, 37957, 37964, 37971, 37979, 37986, 37993, 38000, 38007, 38015, 38022, 38029, 38036, 38043, 38050,
    38057, 38064, 38072, 38079, 38086, 38093, 38100, 38107, 38114, 38121, 38128, 38135, 38142, 38149, 38156, 38163,
    38170, 38177, 38184, 38191, 38198, 38205, 38212, 38218, 38225, 38232, 38239, 38246, 38253, 38260, 38267, 38273,
    38280, 38287, 38294, 38301, 38308, 38314, 38321, 38328, 38335, 38341, 38348, 38355, 38362, 38368, 38375, 38382,
    38389, 38395, 38402, 38409, 38415, 38422, 38429, 38435, 38442, 38449, 38455, 38462, 38468, 38475, 38482, 38488,
    38495, 38501, 38508, 38515, 38521, 38528, 38534, 38541, 38547, 38554, 38560, 38567, 38573, 38580, 38586, 38593,
    38599, 38606, 38612, 38619, 38625, 38631, 38638, 38644, 38651, 38657, 38663, 38670, 38676, 38683, 38689, 38695,
    38702, 38708, 38714, 38721, 38727, 38733, 38740, 38746, 38752, 38758, 38765, 38771, 38777, 38784, 38790, 38796,
    38802, 38809, 38815, 38821, 38827, 38833, 38840, 38846, 38852, 38858, 38864, 38870, 38877, 38883, 38889, 38895,
    38901, 38907, 38913, 38920, 38926, 38932, 38938, 38944, 38950, 38956, 38962, 38968, 38974, 38980, 38986, 38992,
    38998, 39004, 39010, 39016, 39022, 39028, 39034, 39040, 39046, 39052, 39058, 39064, 39070, 39076, 39082, 39088,
    39094, 39100, 39106, 39112, 39118, 39123, 39129, 39135, 39141, 39147, 39153, 39159, 39165, 39170, 39176, 39182,
    39188, 39194, 39200, 39205, 39211, 39217, 39223, 39229, 39234, 39240, 39246, 39252, 39257, 39263, 39269, 39275,
    39280, 39286, 39292, 39298, 39303, 39309, 39315, 39320, 39326, 39332, 39337, 39343, 39349, 39354, 39360, 39366,
    39371, 39377, 39383, 39388, 39394, 39400, 39405, 39411, 39416, 39422, 39428, 39433, 39439, 39444, 39450, 39455,
    39461, 39467, 39472, 39478, 39483, 39489, 39494, 39500, 39505, 39511, 39516, 39522, 39527, 39533, 39538, 39544,
    39549, 39555, 39560, 39566, 39571, 39576, 39582, 39587, 39593, 39598, 39604, 39609, 39614, 39620, 39625, 39631,
    39636, 39641, 39647, 39652, 39657, 39663, 39668, 39674, 39679, 39684, 39690, 39695, 39700, 39706, 39711, 39716,
    39721, 39727, 39732, 39737, 39743, 39748, 39753, 39758, 39764, 39769, 39774, 39780, 39785, 39790, 39795, 39800,
    39806, 39811, 39816, 39821, 39827, 39832, 39837, 39842, 39847, 39853, 39858, 39863, 39868, 39873, 39878, 39884,
    39889, 39894, 39899, 39904, 39909, 39914, 39920, 39925, 39930, 39935, 39940, 39945, 39950, 39955, 39960, 39965,
    39971, 39976, 39981, 39986, 39991, 39996, 40001, 40006, 40011, 40016, 40021, 40026, 40031, 40036, 40041, 40046,
    40051, 40056, 40061, 40066, 40071, 40076, 40081, 40086, 40091, 40096, 40101, 40106, 40111, 40116, 40121, 40126,
    40131, 40136, 40141, 40146, 40150, 40155, 40160, 40165, 40170, 40175, 40180, 40185, 40190, 40195, 40199, 40204,
    40209, 40214, 40219, 40224, 40229, 40234, 40238, 40243, 40248, 40253, 40258, 40263, 40267, 40272, 40277, 40282,
    40287, 40291, 40296, 40301, 40306, 40311, 40315, 40320, 40325, 40330, 40334, 40339, 40344, 40349, 40353, 40358,
    40363, 40368, 40372, 40377, 40382, 40387, 40391, 40396, 40401, 40405, 40410, 40415, 40420, 40424, 40429, 40434,
    40438, 40443, 40448, 40452, 40457, 40462, 40466, 40471, 40476, 40480, 40485, 40490, 40494, 40499, 40503, 40508,
    40513, 40517, 40522, 40526, 40531, 40536, 40540, 40545, 40549, 40554, 40559, 40563, 40568, 40572, 40577, 40581,
    40586, 40591, 40595, 40600, 40604, 40609, 40613, 40618, 40622, 40627, 40631, 40636, 40640, 40645, 40649, 40654,
    40658, 40663, 40667, 40672, 40676, 40681, 40685, 40690, 40694, 40699, 40703, 40708, 40712, 40717, 40721, 40726,
    40730, 40734, 40739, 40743, 40748, 40752, 40757, 40761, 40765, 40770, 40774, 40779, 40783, 40788, 40792, 40796,
    40801, 40805, 40809, 40814, 40818, 40823, 40827, 40831, 40836, 40840, 40844, 40849, 40853, 40857, 40862, 40866,
    40870, 40875, 40879, 40883, 40888, 40892, 40896, 40901, 40905, 40909, 40914, 40918, 40922, 40927, 40931, 40935,
    40939, 40944, 40948, 40952, 40957, 40961, 40965, 40969, 40974, 40978, 40982, 40986, 40991, 40995, 40999, 41003,
    41008, 41012, 41016, 41020, 41024, 41029, 41033, 41037, 41041, 41045, 41050, 41054, 41058, 41062, 41066, 41071,
    41075, 41079, 41083, 41087, 41092, 41096, 41100, 41104, 41108, 41112, 41117, 41121, 41125, 41129, 41133, 41137,
    41141, 41146, 41150, 41154, 41158, 41162, 41166, 41170, 41174, 41178, 41183, 41187, 41191, 41195, 41199, 41203,
    41207, 41211, 41215, 41219, 41223, 41228, 41232, 41236, 41240, 41244, 41248, 41252, 41256, 41260, 41264, 41268,
    41272, 41276, 41280, 41284, 41288, 41292, 41296, 41300, 41304, 41308, 41312, 41316, 41320, 41324, 41328, 41332,
    41336, 41340, 41344, 41348, 41352, 41356, 41360, 41364, 41368, 41372, 41376, 41380, 41384, 41388, 41392, 41396,
    41400, 41404, 41408, 41412, 41416, 41420, 41424, 41428, 41431, 41435, 41439, 41443, 41447, 41451, 41455, 41459,
    41463, 41467, 41471, 41475, 41478, 41482, 41486, 41490, 41494, 41498, 41502, 41506, 41510, 41513, 41517, 41521,
    41525, 41529, 41533, 41537, 41540, 41544, 41548, 41552, 41556, 41560, 41564, 41567, 41571, 41575, 41579, 41583,
    41586, 41590, 41594, 41598, 41602, 41606, 41609, 41613, 41617, 41621, 41625, 41628, 41632, 41636, 41640, 41644,
    41647, 41651, 41655, 41659, 41662, 41666, 41670, 41674, 41678, 41681, 41685, 41689, 41693, 41696, 41700, 41704,
    41708, 41711, 41715, 41719, 41722, 41726, 41730, 41734, 41737, 41741, 41745, 41749, 41752, 41756, 41760, 41763,
    41767, 41771, 41774, 41778, 41782, 41786, 41789, 41793, 41797, 41800, 41804, 41808, 41811, 41815, 41819, 41822,
    41826, 41830, 41833, 41837, 41841, 41844, 41848, 41852, 41855, 41859, 41863, 41866, 41870, 41873, 41877, 41881,
    41884, 41888, 41892, 41895, 41899, 41903, 41906, 41910, 41913, 41917, 41921, 41924, 41928, 41931, 41935, 41939,
    41942, 41946, 41949, 41953, 41956, 41960, 41964, 41967, 41971, 41974, 41978, 41982, 41985, 41989, 41992, 41996,
    41999, 42003, 42006, 42010, 42014, 42017, 42021, 42024, 42028, 42031, 42035, 42038, 42042, 42045, 42049, 42052,
    42056, 42059, 42063, 42066, 42070, 42073, 42077, 42081, 42084, 42088, 42091, 42095, 42098, 42102, 42105, 42108,
    42112, 42115, 42119, 42122, 42126, 42129, 42133, 42136, 42140, 42143, 42147, 42150, 42154, 42157, 42161, 42164,
    42167, 42171, 42174, 42178, 42181, 42185, 42188, 42192, 42195, 42198, 42202, 42205, 42209, 42212, 42216, 42219,
    42222, 42226, 42229, 42233, 42236, 42240, 42243, 42246, 42250, 42253, 42257, 42260, 42263, 42267, 42270, 42273,
    42277, 42280, 42284, 42287, 42290, 42294, 42297, 42301, 42304, 42307, 42311, 42314, 42317, 42321, 42324, 42327,
    42331, 42334, 42337, 42341, 42344, 42348, 42351, 42354, 42358, 42361, 42364, 42368, 42371, 42374, 42378, 42381,
    42384, 42388, 42391, 42394, 42397, 42401, 42404, 42407, 42411, 42414, 42417, 42421, 42424, 42427, 42431, 42434,
    42437, 42440, 42444, 42447, 42450, 42454, 42457, 42460, 42463, 42467, 42470, 42473, 42477, 42480, 42483, 42486,
    42490, 42493, 42496, 42499, 42503, 42506, 42509, 42512, 42516, 42519, 42522, 42525, 42529, 42532, 42535, 42538,
    42542, 42545, 42548, 42551, 42554, 42558, 42561, 42564, 42567, 42571, 42574, 42577, 42580, 42583, 42587, 42590,
    42593, 42596, 42599, 42603, 42606, 42609, 42612, 42615, 42619, 42622, 42625, 42628, 42631, 42634, 42638, 42641,
    42644, 42647, 42650, 42654, 42657, 42660, 42663, 42666, 42669, 42673, 42676, 42679, 42682, 42685, 42688, 42691,
    42695, 42698, 42701, 42704, 42707, 42710, 42713, 42717, 42720, 42723, 42726, 42729, 42732, 42735, 42738, 42742,
    42745, 42748, 42751, 42754, 42757, 42760, 42763, 42767, 42770, 42773, 42776, 42779, 42782, 42785, 42788, 42791,
    42794, 42797, 42801, 42804, 42807, 42810, 42813, 42816, 42819, 42822, 42825, 42828, 42831, 42834, 42838, 42841,
    42844, 42847, 42850, 42853, 42856, 42859, 42862, 42865, 42868, 42871, 42874, 42877, 42880, 42883, 42886, 42889,
    42892, 42896, 42899, 42902, 42905, 42908, 42911, 42914, 42917, 42920, 42923, 42926, 42929, 42932, 42935, 42938,
    42941, 42944, 42947, 42950, 42953, 42956, 42959, 42962, 42965, 42968, 42971, 42974, 42977, 42980, 42983, 42986,
    42989, 42992, 42995, 42998, 43001, 43004, 43007, 43010, 43013, 43016, 43019, 43022, 43025, 43028, 43031, 43034,
    43037, 43039, 43042, 43045, 43048, 43051, 43054, 43057, 43060, 43063, 43066, 43069, 43072, 43075, 43078, 43081,
    43084, 43087, 43090, 43093, 43095, 43098, 43101, 43104, 43107, 43110, 43113, 43116, 43119, 43122, 43125, 43128,
    43131, 43133, 43136, 43139, 43142, 43145, 43148, 43151, 43154, 43157, 43160, 43163, 43165, 43168, 43171, 43174,
    43177, 43180, 43183, 43186, 43189, 43191, 43194, 43197, 43200, 43203, 43206, 43209, 43212, 43214, 43217, 43220,
    43223, 43226, 43229, 43232, 43235, 43237, 43240, 43243, 43246, 43249, 43252, 43255, 43257, 43260, 43263, 43266,
    43269, 43272, 43274, 43277, 43280, 43283, 43286, 43289, 43291, 43294, 43297, 43300, 43303, 43306, 43308, 43311,
    43314, 43317, 43320, 43323, 43325, 43328, 43331, 43334, 43337, 43339, 43342, 43345, 43348, 43351, 43353, 43356,
    43359, 43362, 43365, 43367, 43370, 43373, 43376, 43379, 43381, 43384, 43387, 43390, 43393, 43395, 43398, 43401,
    43404, 43406, 43409, 43412, 43415, 43418, 43420, 43423, 43426, 43429, 43431, 43434, 43437, 43440, 43442, 43445,
    43448, 43451, 43454, 43456, 43459, 43462, 43465, 43467, 43470, 43473, 43475, 43478, 43481, 43484, 43486, 43489,
    43492, 43495, 43497, 43500, 43503, 43506, 43508, 43511, 43514, 43516, 43519, 43522, 43525, 43527, 43530, 43533,
    43536, 43538, 43541, 43544, 43546, 43549, 43552, 43554, 43557, 43560, 43563, 43565, 43568, 43571, 43573, 43576,
    43579, 43581, 43584, 43587, 43590, 43592, 43595, 43598, 43600, 43603, 43606, 43608, 43611, 43614, 43616, 43619,
    43622, 43624, 43627, 43630, 43632, 43635, 43638, 43640, 43643, 43646, 43648, 43651, 43654, 43656, 43659, 43662,
    43664, 43667, 43670, 43672, 43675, 43678, 43680, 43683, 43686, 43688, 43691, 43693, 43696, 43699, 43701, 43704,
    43707, 43709, 43712, 43715, 43717, 43720, 43722, 43725, 43728, 43730, 43733, 43736, 43738, 43741, 43743, 43746,
    43749, 43751, 43754, 43756, 43759, 43762, 43764, 43767, 43770, 43772, 43775, 43777, 43780, 43783, 43785, 43788,
    43790, 43793, 43796, 43798, 43801, 43803, 43806, 43808, 43811, 43814, 43816, 43819, 43821, 43824, 43827, 43829,
    43832, 43834, 43837, 43839, 43842, 43845, 43847, 43850, 43852, 43855, 43857, 43860, 43863, 43865, 43868, 43870,
    43873, 43875, 43878, 43880, 43883, 43886, 43888, 43891, 43893, 43896, 43898, 43901, 43903, 43906, 43908, 43911,
    43914, 43916, 43919, 43921, 43924, 43926, 43929, 43931, 43934, 43936, 43939, 43941, 43944, 43946, 43949, 43952,
    43954, 43957, 43959, 43962, 43964, 43967, 43969, 43972, 43974, 43977, 43979, 43982, 43984, 43987, 43989, 43992,
    43994, 43997, 43999, 44002, 44004, 44007, 44009, 44012, 44014, 44017, 44019, 44022, 44024, 44027, 44029, 44032,
    44034, 44037, 44039, 44042, 44044, 44047, 44049, 44052, 44054, 44057, 44059, 44061, 44064, 44066, 44069, 44071,
    44074, 44076, 44079, 44081, 44084, 44086, 44089, 44091, 44094, 44096, 44098, 44101, 44103, 44106, 44108, 44111,
    44113, 44116, 44118, 44121, 44123, 44125, 44128, 44130, 44133, 44135, 44138, 44140, 44143, 44145, 44147, 44150,
    44152, 44155, 44157, 44160, 44162, 44165, 44167, 44169, 44172, 44174, 44177, 44179, 44181, 44184, 44186, 44189,
    44191, 44194, 44196, 44198, 44201, 44203, 44206, 44208, 44210, 44213, 44215, 44218, 44220, 44223, 44225, 44227,
    44230, 44232, 44235, 44237, 44239, 44242, 44244, 44247, 44249, 44251, 44254, 44256, 44259, 44261, 44263, 44266,
    44268, 44270, 44273, 44275, 44278, 44280, 44282, 44285, 44287, 44290, 44292, 44294, 44297, 44299, 44301, 44304,
    44306, 44308, 44311, 44313, 44316, 44318, 44320, 44323, 44325, 44327, 44330, 44332, 44335, 44337, 44339, 44342,
    44344, 44346, 44349, 44351, 44353, 44356, 44358, 44360, 44363, 44365, 44367, 44370, 44372, 44374, 44377, 44379,
    44381, 44384, 44386, 44389, 44391, 44393, 44396, 44398, 44400, 44403, 44405, 44407, 44409, 44412, 44414, 44416,
    44419, 44421, 44423, 44426, 44428, 44430, 44433, 44435, 44437, 44440, 44442, 44444, 44447, 44449, 44451, 44454,
    44456, 44458, 44460, 44463, 44465, 44467, 44470, 44472, 44474, 44477, 44479, 44481, 44484, 44486, 44488, 44490,
    44493, 44495, 44497, 44500, 44502, 44504, 44506, 44509, 44511, 44513, 44516, 44518, 44520, 44522, 44525, 44527,
    44529, 44532, 44534, 44536, 44538, 44541, 44543, 44545, 44547, 44550, 44552, 44554, 44557, 44559, 44561, 44563,
    44566, 44568, 44570, 44572, 44575, 44577, 44579, 44581, 44584, 44586, 44588, 44591, 44593, 44595, 44597, 44600,
    44602, 44604, 44606, 44609, 44611, 44613, 44615, 44618, 44620, 44622, 44624, 44626, 44629, 44631, 44633, 44635,
    44638, 44640, 44642, 44644, 44647, 44649, 44651, 44653, 44656, 44658, 44660, 44662, 44664, 44667, 44669, 44671,
    44673, 44676, 44678, 44680, 44682, 44684, 44687, 44689, 44691, 44693, 44696, 44698, 44700, 44702, 44704, 44707,
    44709, 44711, 44713, 44715, 44718, 44720, 44722, 44724, 44726, 44729, 44731, 44733, 44735, 44737, 44740, 44742,
    44744, 44746, 44748, 44751, 44753, 44755, 44757, 44759, 44762, 44764, 44766, 44768, 44770, 44772, 44775, 44777,
    44779, 44781, 44783, 44786, 44788, 44790, 44792, 44794, 44796, 44799, 44801, 44803, 44805, 44807, 44810, 44812,
    44814, 44816, 44818, 44820, 44823, 44825, 44827, 44829, 44831, 44833, 44835, 44838, 44840, 44842, 44844, 44846,
    44848, 44851, 44853, 44855, 44857, 44859, 44861, 44864, 44866, 44868, 44870, 44872, 44874, 44876, 44879, 44881,
    44883, 44885, 44887, 44889, 44891, 44894, 44896, 44898, 44900, 44902, 44904, 44906, 44908, 44911, 44913, 44915,
    44917, 44919, 44921, 44923, 44926, 44928, 44930, 44932, 44934, 44936, 44938, 44940, 44942, 44945, 44947, 44949,
    44951, 44953, 44955, 44957, 44959, 44962, 44964, 44966, 44968, 44970, 44972, 44974, 44976, 44978, 44981, 44983,
    44985, 44987, 44989, 44991, 44993, 44995, 44997, 44999, 45002, 45004, 45006, 45008, 45010, 45012, 45014, 45016,
    45018, 45020, 45022, 45025, 45027, 45029, 45031, 45033, 45035, 45037, 45039, 45041, 45043, 45045, 45048, 45050,
    45052, 45054, 45056, 45058, 45060, 45062, 45064, 45066, 45068, 45070, 45072, 45075, 45077, 45079, 45081, 45083,
    45085, 45087, 45089, 45091, 45093, 45095, 45097, 45099, 45101, 45103, 45105, 45108, 45110, 45112, 45114, 45116,
    45118, 45120, 45122, 45124, 45126, 45128, 45130, 45132, 45134, 45136, 45138, 45140, 45142, 45144, 45147, 45149,
    45151, 45153, 45155, 45157, 45159, 45161, 45163, 45165, 45167, 45169, 45171, 45173, 45175, 45177, 45179, 45181,
    45183, 45185, 45187, 45189, 45191, 45193, 45195, 45197, 45199, 45202, 45204, 45206, 45208, 45210, 45212, 45214,
    45216, 45218, 45220, 45222, 45224, 45226, 45228, 45230, 45232, 45234, 45236, 45238, 45240, 45242, 45244, 45246,
    45248, 45250, 45252, 45254, 45256, 45258, 45260, 45262, 45264, 45266, 45268, 45270, 45272, 45274, 45276, 45278,
    45280, 45282, 45284, 45286, 45288, 45290, 45292, 45294, 45296, 45298, 45300, 45302, 45304, 45306, 45308, 45310,
    45312, 45314, 45316, 45318, 45320, 45322, 45324, 45326, 45328, 45330, 45332, 45334, 45336, 45338, 45340, 45342,
    45344, 45346, 45347, 45349, 45351, 45353, 45355, 45357, 45359, 45361, 45363, 45365, 45367, 45369, 45371, 45373,
    45375, 45377, 45379, 45381, 45383, 45385, 45387, 45389, 45391, 45393, 45395, 45397, 45399, 45401, 45403, 45404,
    45406, 45408, 45410, 45412, 45414, 45416, 45418, 45420, 45422, 45424, 45426, 45428, 45430, 45432, 45434, 45436,
    45438, 45440, 45441, 45443, 45445, 45447, 45449, 45451, 45453, 45455, 45457, 45459, 45461, 45463, 45465, 45467,
    45469, 45471, 45472, 45474, 45476, 45478, 45480, 45482, 45484, 45486, 45488, 45490, 45492, 45494, 45496, 45498,
    45499, 45501, 45503, 45505, 45507, 45509, 45511, 45513, 45515, 45517, 45519, 45521, 45522, 45524, 45526, 45528,
    45530, 45532, 45534, 45536, 45538, 45540, 45542, 45543, 45545, 45547, 45549, 45551, 45553, 45555, 45557, 45559,
    45561, 45563, 45564, 45566, 45568, 45570, 45572,
};

// clang-format on

static void subtract_noise(q15_t *iq)
{
    q15_t mag_q15[DENOISER_FFT_SIZE / 4];
    static q31_t lpfMag[DENOISER_FFT_SIZE / 4];

    arm_cmplx_mag_fast_q15(iq, mag_q15, DENOISER_FFT_SIZE / 4);

    for (size_t i = 0; i < DENOISER_FFT_SIZE / 4; i++)
    {
        lpfMag[i] = ((ONE_MINUS_KFRAME * (q31_t)mag_q15[i]) >> 14) + ((KFRAME * (q31_t)lpfMag[i]) >> 14);
        if (lpfMag[i] < noise_frames[noise_frame_idx][i])
        {
            // make sure magnitudes are not zero to avoid division error
            if (lpfMag[i] < 1)
            {
                lpfMag[i] = 1;
            }
            noise_frames[noise_frame_idx][i] = lpfMag[i];
        }

        // find minimal amplitude for the bin
        const q15_t mmse = MIN(MIN(noise_frames[0][i], noise_frames[1][i]), MIN(noise_frames[2][i], noise_frames[3][i]));
        const q31_t snr = lpfMag[i] / mmse;

        const q31_t snr_dB = db_lut[snr < 3000 ? snr : 2999];
        q31_t alpha = (6 * 32767) - snr_dB;

        if (alpha > (12 * 32767))
        {
            alpha = (12 * 32767);
        }
        if (alpha < 32767)
        {
            alpha = 32767;
        }

        const q31_t a = 32767 - (alpha / snr);
        const q31_t b = ((q31_t)(32767)) / (3 * snr);
        //                                  ^- spectral floor - decrease to reduce "musical noise"
        const q31_t gain = MAX(a, b);

        iq[(2 * i)] = (iq[(2 * i)] * gain) >> 15;
        iq[(2 * i) + 1] = (iq[(2 * i) + 1] * gain) >> 15;
        iq[2 * (DENOISER_FFT_SIZE - 1 - i)] = (iq[2 * (DENOISER_FFT_SIZE - 1 - i)] * gain) >> 15;
        iq[2 * (DENOISER_FFT_SIZE - 1 - i) + 1] = (iq[2 * (DENOISER_FFT_SIZE - 1 - i) + 1] * gain) >> 15;
    }

    // remove "dead" bins
    for (size_t i = DENOISER_FFT_SIZE / 4; i < DENOISER_FFT_SIZE - (DENOISER_FFT_SIZE / 4); i++)
    {
        iq[(2 * i)] = 0;
        iq[(2 * i) + 1] = 0;
    }

    // update the counters
    noise_frame_counter++;
    if (noise_frame_counter == NOISE_FRAMES_ROT_PERIOD)
    {
        noise_frame_idx++;
        if (noise_frame_idx == NOISE_FRAMES_NUM)
        {
            noise_frame_idx = 0;
        }
        for (size_t i = 0; i < DENOISER_FFT_SIZE / 2; i++)
        {
            noise_frames[noise_frame_idx][i] = Q31_MAX;
        }
        noise_frame_counter = 0;
    }
}

void denoiser_init(denoiser_t *self)
{
    float win[DENOISER_FFT_SIZE];

    arm_status status = arm_rfft_init_128_q15(&self->fft_i, 0, 1);
    hard_assert(status == ARM_MATH_SUCCESS);
    status = arm_rfft_init_128_q15(&self->ifft_i, 1, 1);
    hard_assert(status == ARM_MATH_SUCCESS);

    arm_hanning_f32(win, DENOISER_FFT_SIZE);
    arm_float_to_q15(win, self->window, DENOISER_FFT_SIZE);

    for (size_t i = 0; i < DENOISER_FFT_SIZE / 4; i++)
    {
        for (size_t j = 0; j < NOISE_FRAMES_NUM; j++)
        {
            noise_frames[j][i] = Q31_MAX;
        }
    }
}

void denoiser_process(denoiser_t *self, q15_t *const x, size_t nx)
{
    hard_assert(nx == (DENOISER_FFT_SIZE / 2));
    arm_copy_q15(self->prev_in_frame, self->tmp_in_buf, DENOISER_FFT_SIZE / 2);
    arm_copy_q15(x, &self->tmp_in_buf[DENOISER_FFT_SIZE / 2], DENOISER_FFT_SIZE / 2);
    arm_copy_q15(x, self->prev_in_frame, nx);

    arm_mult_q15(self->tmp_in_buf, self->window, self->tmp_in_buf, DENOISER_FFT_SIZE);

    arm_rfft_q15(&self->fft_i, self->tmp_in_buf, self->tmp_out_buf);
    subtract_noise(self->tmp_out_buf);
    arm_rfft_q15(&self->ifft_i, self->tmp_out_buf, self->tmp_in_buf);

    arm_mult_q15(self->tmp_in_buf, self->window, self->tmp_in_buf, DENOISER_FFT_SIZE);
    arm_copy_q15(self->tmp_in_buf, x, DENOISER_FFT_SIZE / 2);
    arm_add_q15(self->prev_out_frame, x, x, DENOISER_FFT_SIZE / 2);

    for (size_t i = 0; i < nx; i++)
    {
        x[i] <<= 7;
    }

    arm_copy_q15(&self->tmp_in_buf[DENOISER_FFT_SIZE / 2], self->prev_out_frame, nx);
}
